import { createClient } from "@supabase/supabase-js"; import dotenv from "dotenv"; import path from "path"; import { fileURLToPath } from "url"; import fs from "fs"; const __dirname = path.dirname(fileURLToPath(import.meta.url)); dotenv.config({ path: path.join(__dirname, ".env.local") }); const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY); async function safeDeploy() { console.log("ğŸ›¡ï¸ video-clozett å …ç‰¢åŒ–ãƒ¢ãƒ¼ãƒ‰èµ·å‹•..."); setInterval(async () => { try { const { data } = await supabase.from("system_instructions").select("*").eq("status", "pending").order("created_at", { ascending: true }).limit(1); if (data && data.length > 0) { const task = data[0]; const targetPath = path.resolve(__dirname, task.file_path); if (fs.existsSync(targetPath)) fs.copyFileSync(targetPath, targetPath + ".bak"); fs.writeFileSync(targetPath, task.code_content); await supabase.from("system_instructions").update({ status: "completed" }).eq("id", task.id); console.log("âœ… è‡ªå‹•æ›´æ–°å®Œäº†: " + task.file_path); if (process.env.SLACK_WEBHOOK_URL) await fetch(process.env.SLACK_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text: "ğŸ›¡ï¸ **video-clozett è‡ªå¾‹æ›´æ–°æˆåŠŸ**\nâœ… å¤–éƒ¨ã‹ã‚‰ã®æ›¸ãæ›ãˆãƒ«ãƒ¼ãƒˆãŒæ­£å¸¸ã«é–‹é€šã—ã¾ã—ãŸã€‚" }) }); } else { process.stdout.write("."); } } catch (e) { console.error(e); } }, 5000); } safeDeploy();