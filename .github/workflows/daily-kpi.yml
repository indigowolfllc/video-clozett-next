name: Daily KPI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # æ¯æ—¥UTC 0:00å®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“9:00ï¼‰

jobs:
  daily-kpi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â‘  Supabaseã«KPIã‚’INSERTï¼ˆä¾‹ï¼‰
      - name: Insert KPI to Supabase
        run: |
          curl -X POST \
          -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
                "youtube_views": 1520,
                "ad_revenue": 320.50,
                "stripe_revenue": 12000,
                "cost": 85.30
              }' \
          "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/rest/v1/kpi"

      # â‘¡ æœ€æ–°KPIã‚’å–å¾—
      - name: Fetch Latest KPI
        id: fetch_kpi
        run: |
          RESPONSE=$(curl -s \
          -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
          "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/rest/v1/kpi?select=*&order=created_at.desc&limit=1")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      # â‘¢ Slackã«é€ä¿¡
      - name: Send KPI to Slack
        run: |
          curl -X POST \
          -H "Content-type: application/json" \
          --data "{\"text\":\"ğŸ“Š Daily KPI\n${{ steps.fetch_kpi.outputs.response }}\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
